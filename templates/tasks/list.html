{% extends 'base.html' %}

{% block content %}
<div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
        <a href="{% url 'tasks:create' %}" class="btn btn-success btn-lg">
            + –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
        </a>
    </div>

    {% if tasks %}
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–°—Ä–æ–∫</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="tasks-table-body">
                {% for task in tasks %}
                <tr data-task-id="{{ task.id }}">
                    <td>{{ task.title }}</td>
                    <td>
                        {% if task.status == 'done' %}
                            <span class="badge bg-success">{{ task.get_status_display }}</span>
                        {% elif task.status == 'in_progress' %}
                            <span class="badge bg-warning text-dark">{{ task.get_status_display }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ task.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if task.priority == 'high' %}
                            <span class="badge bg-danger">{{ task.get_priority_display }}</span>
                        {% elif task.priority == 'medium' %}
                            <span class="badge bg-info text-dark">{{ task.get_priority_display }}</span>
                        {% else %}
                            <span class="badge bg-light text-dark border">{{ task.get_priority_display }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if task.due_date %}
                            {{ task.due_date|date:"d.m.Y H:i" }}
                            {% if task.is_overdue %}
                                <span class="text-danger ms-2">‚ö†Ô∏è</span>
                            {% endif %}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'tasks:update' task.pk %}" class="btn btn-sm btn-primary">–†–µ–¥–∞–∫—Ç.</a>
                        <a href="{% url 'tasks:delete' task.pk %}" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="text-center text-muted">
            <p class="lead">–ù–µ—Ç –∑–∞–¥–∞—á</p>
            <a href="{% url 'tasks:create' %}" class="btn btn-outline-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é</a>
        </div>
    {% endif %}
</div>

<!-- WebSocket: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ -->
<script>
const userId = {{ user.id|default:"null" }};
const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
const wsPath = `${wsScheme}://${window.location.host}/ws/notifications/`;
let socket = null;

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
function connectWebSocket() {
    socket = new WebSocket(wsPath);

    socket.onopen = () => console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω");

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === "task_update") {
            const task = data.task;
            const tbody = document.getElementById("tasks-table-body");

            if (data.action === "created") {
                addTaskToList(task);
            } else if (data.action === "deleted") {
                removeTaskFromList(task.id);
            } else if (data.action === "updated") {
                updateTaskInList(task);
            }
        }

        if (data.type === "notification") {
            showNotification(data.message);
        }
    };

    socket.onclose = () => {
        console.log("‚ùå WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        setTimeout(connectWebSocket, 5000);
    };

    socket.onerror = (e) => console.error("WebSocket –æ—à–∏–±–∫–∞:", e);
}

// –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –Ω–∞—á–∞–ª–æ —Ç–∞–±–ª–∏—Ü—ã
function addTaskToList(task) {
    const tbody = document.getElementById("tasks-table-body");
    const row = document.createElement("tr");
    row.dataset.taskId = task.id;

    row.innerHTML = `
        <td>${task.title}</td>
        <td><span class="badge bg-secondary">${task.status}</span></td>
        <td><span class="badge bg-light text-dark border">${task.priority}</span></td>
        <td>${task.due_date ? new Date(task.due_date).toLocaleString() : "‚Äî"}</td>
        <td>
            <a href="/${task.id}/update" class="btn btn-sm btn-primary">–†–µ–¥–∞–∫—Ç.</a>
            <a href="/${task.id}/delete" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
        </td>
    `;

    tbody.prepend(row);
    // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –∑–∞–¥–∞—á", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    const noTasks = document.querySelector('.text-center.text-muted');
    if (noTasks) noTasks.remove();
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —Å–ø–∏—Å–∫–∞
function removeTaskFromList(taskId) {
    const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
    if (row) row.remove();

    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å "–ù–µ—Ç –∑–∞–¥–∞—á"
    const tbody = document.getElementById("tasks-table-body");
    if (tbody.children.length === 0) {
        tbody.innerHTML = '';
        const container = document.querySelector('.card.p-4');
        const noTasks = document.createElement('div');
        noTasks.className = 'text-center text-muted';
        noTasks.innerHTML = `
            <p class="lead">–ù–µ—Ç –∑–∞–¥–∞—á</p>
            <a href="{% url 'tasks:create' %}" class="btn btn-outline-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é</a>
        `;
        container.appendChild(noTasks);
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ —Å–ø–∏—Å–∫–µ
function updateTaskInList(task) {
    const row = document.querySelector(`tr[data-task-id="${task.id}"]`);
    if (!row) return;

    row.querySelector('td:nth-child(1)').textContent = task.title;
    row.querySelector('td:nth-child(2) .badge').textContent = task.status;
    row.querySelector('td:nth-child(3) .badge').textContent = task.priority;
    row.querySelector('td:nth-child(4)').textContent = task.due_date
        ? new Date(task.due_date).toLocaleString()
        : "‚Äî";
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show mt-3';
    notification.innerHTML = `
        <strong>üîî</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.prepend(notification);
    setTimeout(() => notification.remove(), 6000);
}

// –ó–∞–ø—É—Å–∫ WebSocket, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
if (userId) {
    connectWebSocket();
}
</script>
</body>
</html>
{% endblock %}